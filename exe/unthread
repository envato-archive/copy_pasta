#!/usr/bin/env ruby

require "unthread"
require "optparse"

options = { threads: 100 }

op = OptionParser.new do |opts|
  opts.banner = "Usage: #{$PROGRAM_NAME} [options]"

  opts.on("-oDIR", "--output-dir=DIR", "Directory to extract files") do |dir|
    options[:output_dir] = dir
  end

  banner = "Number of threads to use for extraction (Default: 100)"

  opts.on("-nTHREADS", "--num-threads=THREADS", Integer, banner) do |n|
    options[:threads] = n
  end
  opts.on("-sDIRECTORY", "--source-directory=DIRECTORY", "The source directory to copy from") do |t|
    options[:directory] = t
  end

  opts.on("-pPATTERN", "--pattern=PATTERN", "Extract files that match PATTERN") do |t|
    options[:pattern] = t
  end
end

op.parse!

abort op.banner if options[:directory].nil? || options[:output_dir].nil?

input   = Unthread::DirectoryReader.new(options.fetch(:directory), options[:pattern])
dir     = options.fetch(:output_dir)
threads = options.fetch(:threads)

Unthread::DirectoryCreator.run(input.directories, dir, threads: threads)
Unthread::FileCreator.run(input.files, dir, threads: threads)
